name: Cleanup old PR schemas

on:
  schedule:
    - cron: "0 3 * * *"   # every night at 03:00 UTC
  workflow_dispatch:      # manual trigger button

jobs:
  cleanup:
    runs-on: ubuntu-latest
    environment: DBT_ETH

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: "3.12.10"

      - name: Install dbt
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core==1.9.4 dbt-snowflake==1.9.4

      - name: Setup dbt profile
        run: |
          mkdir -p ~/.dbt
          echo "$DBT_PROFILES_YML" > ~/.dbt/profiles.yml
          echo "$DBT_PRIVATE_KEY" > ~/.dbt/rsa_key.p8
          chmod 600 ~/.dbt/rsa_key.p8
        env:
          DBT_PROFILES_YML: ${{ secrets.DBT_PROFILES_YML }}
          DBT_PRIVATE_KEY: ${{ secrets.DBT_PRIVATE_KEY }}
          DBT_CI_SCHEMA: dummy_schema

      - name: Cleanup old PR schemas
        run: |
          dbt run-operation pr_schema_cleanup \
            --args "{database_to_clean: STAGE, age_in_days: 10}" \
            --target ci
